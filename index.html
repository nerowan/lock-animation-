<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>京杭大运河 - 动画 & 问答游戏（AI对手头像版）</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    /* ===================== 全局与重置 ===================== */
    * {
      margin: 0; 
      padding: 0; 
      box-sizing: border-box;
    }
    html, body {
      width: 100%;
      height: 100%;
      overflow: hidden; 
      font-family: "Microsoft YaHei", sans-serif;
      background: #b3d9ff;
      font-size: 16px;
    }
    .hidden {
      display: none !important;
    }

    /* ===================== 主容器 ===================== */
    #app {
      width: 100%;
      height: 100%;
      position: relative;
    }

    /* ===================== 主菜单 ===================== */
    #mainMenu {
      width: 100%;
      height: 100%;
      background: linear-gradient(to right, #4fc3f7, #81d4fa);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      position: relative;
      padding: 2rem;
    }
    #mainMenu h1 {
      font-size: 1.5rem;
      color: #fff;
      margin-bottom: 2rem;
      text-shadow: 2px 2px 5px rgba(0,0,0,0.3);
      text-align: center;
    }
    .menu-btn {
      width: 12rem;
      padding: 0.75rem;
      margin: 0.5rem;
      font-size: 1rem;
      color: #fff;
      background: #0288d1;
      border: none;
      border-radius: 0.5rem;
      cursor: pointer;
      transition: background 0.3s;
      text-align: center;
      box-shadow: 0 0.2rem 0.6rem rgba(0,0,0,0.2);
    }
    .menu-btn:hover {
      background: #0277bd;
    }
    /* 神秘小游戏按钮，固定在右下角 */
    #mysteryGameBtn {
      position: absolute;
      bottom: 1.5rem;
      right: 1.5rem;
      padding: 0.75rem 1rem;
      background: #e91e63;
      color: #fff;
      border: none;
      border-radius: 0.5rem;
      cursor: pointer;
      box-shadow: 0 0.2rem 0.6rem rgba(0,0,0,0.2);
      transition: background 0.3s;
      font-size: 0.9rem;
    }
    #mysteryGameBtn:hover {
      background: #d81b60;
    }

    /* ===================== 动画页面 ===================== */
    #animationPage {
      width: 100%;
      height: 100%;
      position: absolute;
      top:0;
      left:0;
      background: #b3d9ff;
    }
    .backToMenuBtn {
      position: absolute;
      top: 1rem;
      left: 1rem;
      padding: 0.5rem 0.8rem;
      background: #f44336;
      color: #fff;
      border: none;
      border-radius: 0.5rem;
      cursor: pointer;
      z-index: 999;
      box-shadow: 0 0.2rem 0.6rem rgba(0,0,0,0.3);
      transition: background 0.3s;
      font-size: 0.9rem;
    }
    .backToMenuBtn:hover {
      background: #d32f2f;
    }
    #animationContainer {
      width: 100%;
      height: 100%;
      position: relative;
      perspective: 1000px; 
    }

    .scene {
      position: absolute;
      top:0; 
      left:0;
      width: 100%;
      height: 100%;
      display: none;
      overflow: hidden;
    }
    .active {
      display: block;
    }
    .fade-in {
      animation: fadeIn 1.5s forwards ease;
    }
    .fade-out {
      animation: fadeOut 1.5s forwards ease;
    }
    @keyframes fadeIn {
      0% { opacity: 0; }
      100% { opacity: 1; }
    }
    @keyframes fadeOut {
      0% { opacity: 1; }
      100% { opacity: 0; }
    }

    /* “进入下一部分”按钮 */
    .next-part-btn {
      position: absolute;
      bottom: 1.25rem;
      right: 1.25rem;
      padding: 0.6rem 1rem;
      background: #8bc34a;
      color: #fff;
      border: none;
      border-radius: 0.5rem;
      cursor: pointer;
      box-shadow: 0 0.2rem 0.8rem rgba(0,0,0,0.2);
      transition: background 0.3s;
      font-size: 0.9rem;
      z-index: 998;
    }
    .next-part-btn:hover {
      background: #7cb342;
    }

    /* 云、波浪、小船、卡片等样式（与之前示例相同）... 省略注释，仅保留key CSS */
    .cloud {
      position: absolute;
      width: 12rem;
      height: 6rem;
      background: #fff;
      border-radius: 6rem;
      box-shadow: 60px 30px 0 20px #fff, 90px 40px 0 10px #fff;
      opacity: 0.8;
      animation: cloudMove 30s linear infinite;
    }
    @keyframes cloudMove {
      0% { transform: translateX(-300px); }
      100% { transform: translateX(1300px); }
    }
    .water {
      position: absolute;
      bottom: 0;
      width: 100%;
      height: 40%;
      background: linear-gradient(to top, #0277bd 0%, #4fc3f7 100%);
      overflow: hidden;
    }
    .wave {
      position: absolute;
      width: 125rem;
      height: 12.5rem;
      top: -6rem;
      left: 0;
      background: rgba(255,255,255,0.3);
      border-radius: 50%;
      animation: waveAnimation 6s infinite linear;
      opacity: 0.8;
    }
    .wave:nth-child(2) { animation-delay: -2s; opacity: 0.5; }
    @keyframes waveAnimation {
      0% { transform: translateX(0); }
      100% { transform: translateX(-62.5rem); }
    }
    .boat {
      position: absolute;
      width: 7.5rem;  
      height: 3.75rem;
      left: 10%;
      bottom: 20%;
      background-color: #8d6e63; 
      border-radius: 0 0 5rem 5rem;
      animation: boatFloat 3s ease-in-out infinite;
      box-shadow: 0 0.3rem 0.6rem rgba(0,0,0,0.3);
    }
    .boat::before {
      content: "";
      position: absolute;
      width: 3.75rem;
      height: 3.75rem;
      right: 0.6rem;
      bottom: 1.875rem;
      background-color: #ffca28;
      transform-origin: bottom right;
      transform: skew(-10deg, 0);
    }
    @keyframes boatFloat {
      0%, 100% { transform: translateY(0px) rotate(0deg); }
      50% { transform: translateY(-5px) rotate(1deg); }
    }
    .card {
      background-color: rgba(255, 255, 255, 0.8);
      backdrop-filter: blur(4px);
      box-shadow: 0 0.25rem 1.25rem rgba(0,0,0,0.2);
      border-radius: 0.75rem;
      padding: 1rem;
      position: relative;
      max-width: 80%;
      margin: 0 auto;
    }

    /* ===================== 问答游戏页面 ===================== */
    #quizPage {
      width: 100%;
      height: 100%;
      background: #eceff1;
      position: absolute;
      top:0;
      left:0;
      display: flex;
      flex-direction: column;
    }
    .quiz-header {
      background: #0288d1;
      color: #fff;
      padding: 1rem;
      text-align: center;
      position: relative;
    }
    .quiz-header h2 {
      margin-bottom: 0.5rem;
      font-size: 1.2rem;
    }
    .quiz-header .backToMenuBtn {
      top: 0.7rem;
      left: 0.7rem;
    }
    .quiz-container {
      flex: 1;
      overflow-y: auto;
      padding: 1rem;
    }
    .quiz-question {
      margin-bottom: 1rem;
      padding: 1rem;
      background: #fff;
      border-radius: 0.5rem;
      box-shadow: 0 0.2rem 0.4rem rgba(0,0,0,0.1);
    }
    .quiz-question h3 {
      font-size: 1rem;
      margin-bottom: 0.5rem;
    }
    .quiz-question .option {
      margin: 0.3rem 0;
      cursor: pointer;
      font-size: 0.9rem;
    }
    .quiz-submit-btn {
      width: 8rem;
      padding: 0.5rem;
      margin: 1rem auto;
      display: block;
      background: #00796b;
      color: #fff;
      border: none;
      border-radius: 0.5rem;
      font-size: 1rem;
      cursor: pointer;
      text-align: center;
      transition: background 0.3s;
    }
    .quiz-submit-btn:hover {
      background: #004d40;
    }
    .quiz-result {
      text-align: center;
      margin-top: 0.5rem;
      font-size: 1rem;
      color: #333;
    }
    /* 排行榜部分，带头像 */
    .leaderboard {
      margin-top: 1rem;
      text-align: center;
      color: #555;
      font-size: 0.9rem;
    }
    .leaderboard .rank-item {
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0.5rem 0;
    }
    .leaderboard img {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      margin-right: 8px;
      object-fit: cover;
      box-shadow: 0 0.1rem 0.3rem rgba(0,0,0,0.2);
    }

    /* ===================== 小屏响应式（省略详细，只演示关键） ===================== */
    @media (max-width:600px){
      /* 可在此调整font-size,按钮大小,等... */
      html {
        font-size: 14px; 
      }
    }

  </style>
</head>
<body>
<div id="app">
  <!-- ========== 主菜单 ========== -->
  <div id="mainMenu">
    <h1>京杭大运河 - 动画 & 问答游戏</h1>
    <button class="menu-btn" id="btnGoAnimation">进入动画</button>
    <button class="menu-btn" id="btnGoQuiz">问答游戏</button>
    <!-- 神秘小游戏按钮(右下角) -->
    <button id="mysteryGameBtn" onclick="location.href='game.html'">神秘小游戏</button>
  </div>

  <!-- ========== 动画页面 ========== -->
  <div id="animationPage" class="hidden">
    <button class="backToMenuBtn" id="btnBackMenuFromAnimation">返回主菜单</button>
    <div id="animationContainer">
      <!-- 场景1 -->
      <div id="scene1" class="scene">
        <div class="cloud" style="top:10%; left:15%;"></div>
        <div class="cloud" style="top:20%; left:40%; animation-delay:-15s;"></div>
        <div class="water">
          <div class="wave"></div>
          <div class="wave"></div>
        </div>
        <div class="boat"></div>
        <div class="card fade-in" style="
          position:absolute; 
          top:15%; 
          left:10%;
          width:80%;
        ">
          <h2>欢迎来到“探秘京杭大运河”解说短片</h2>
          <p>
            今天我们将一起了解在京杭大运河中一个非常重要的水利设施——水闸。
            它就像一扇‘水门’，帮助船只在不同水位之间顺利通过，还能调节水流，
            保护沿河地区的安全。
          </p>
        </div>
        <button class="next-part-btn" id="scene1NextBtn">进入下一部分</button>
      </div>

      <!-- 场景2、3、4、5、6 略... 与之前类似，只保留核心结构 -->
      <!-- 同理包含 “进入下一部分”按钮 scene2NextBtn, scene3NextBtn, scene4NextBtn, scene5NextBtn -->
      <!-- ...请复制前面示例里场景2~6 的HTML结构... -->

      <!-- 场景2 -->
      <div id="scene2" class="scene">
        <!-- 云、水面、小船、卡片... -->
        <button class="next-part-btn" id="scene2NextBtn">进入下一部分</button>
      </div>

      <!-- 场景3 -->
      <div id="scene3" class="scene">
        <!-- 云、水面、小船、卡片... -->
        <button class="next-part-btn" id="scene3NextBtn">进入下一部分</button>
      </div>

      <!-- 场景4（小游戏） -->
      <div id="scene4" class="scene">
        <!-- 云、水面、小船、操作面板... -->
        <button class="next-part-btn" id="scene4NextBtn">进入下一部分</button>
      </div>

      <!-- 场景5 -->
      <div id="scene5" class="scene">
        <!-- 背景、文字... -->
        <button class="next-part-btn" id="scene5NextBtn">进入下一部分</button>
      </div>

      <!-- 场景6 -->
      <div id="scene6" class="scene">
        <div class="final-view fade-in">
          <div class="final-pan"></div>
          <div class="final-text">
            <p>
              “通过了解京杭大运河内水闸的类型和原理，
              我们看到了古代智慧与现代科技的结合。
              希望大家在下一次参观大运河时，能更加了解这条伟大的水路，
              一起守护大运河的未来！”
            </p>
            <p style="margin-top:1rem; text-align:right; font-weight:bold;">—— 感谢观看！</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ========== 问答游戏页面(重点：AI头像) ========== -->
  <div id="quizPage" class="hidden">
    <div class="quiz-header">
      <button class="backToMenuBtn" id="btnBackMenuFromQuiz">返回</button>
      <h2>大运河水闸知识 - 问答游戏</h2>
      <p>测试一下你对水闸和大运河的了解程度吧！</p>
    </div>
    <div class="quiz-container" id="quizContainer">
      <!-- 示例题1 -->
      <div class="quiz-question" data-answer="1">
        <h3>1. 大运河主要功能不包括以下哪项？</h3>
        <label class="option"><input type="radio" name="q1" value="1"> 火箭、飞行器发射</label><br/>
        <label class="option"><input type="radio" name="q1" value="2"> 运输货物与人员</label><br/>
        <label class="option"><input type="radio" name="q1" value="3"> 分洪防汛</label><br/>
        <label class="option"><input type="radio" name="q1" value="4"> 调节水位</label>
      </div>
      <!-- 示例题2 -->
      <div class="quiz-question" data-answer="2">
        <h3>2. 哪种水闸主要用于帮助船舶通过？</h3>
        <label class="option"><input type="radio" name="q2" value="1"> 节制闸</label><br/>
        <label class="option"><input type="radio" name="q2" value="2"> 船闸</label><br/>
        <label class="option"><input type="radio" name="q2" value="3"> 分洪闸</label><br/>
        <label class="option"><input type="radio" name="q2" value="4"> 潮汐闸</label>
      </div>
      <!-- 示例题3 -->
      <div class="quiz-question" data-answer="3">
        <h3>3. 当需要让闸室水位与下游持平时，应先开启？</h3>
        <label class="option"><input type="radio" name="q3" value="1"> 下闸门</label><br/>
        <label class="option"><input type="radio" name="q3" value="2"> 上排水阀</label><br/>
        <label class="option"><input type="radio" name="q3" value="3"> 下排水阀</label><br/>
        <label class="option"><input type="radio" name="q3" value="4"> 不需要开启阀门</label>
      </div>
      
      <button class="quiz-submit-btn" id="quizSubmitBtn">提交答案</button>
      <div class="quiz-result" id="quizResult"></div>
      <!-- 排行榜区域（带本地头像） -->
      <div class="leaderboard" id="leaderboardArea"></div>
    </div>
  </div>
</div>

<script>
  /* ========== DOM元素 & 逻辑 ========== */
  const mainMenu = document.getElementById('mainMenu');
  const animationPage = document.getElementById('animationPage');
  const quizPage = document.getElementById('quizPage');

  const btnGoAnimation = document.getElementById('btnGoAnimation');
  const btnGoQuiz = document.getElementById('btnGoQuiz');
  const btnBackMenuFromAnimation = document.getElementById('btnBackMenuFromAnimation');
  const btnBackMenuFromQuiz = document.getElementById('btnBackMenuFromQuiz');

  // 问答
  const quizSubmitBtn = document.getElementById('quizSubmitBtn');
  const quizResult = document.getElementById('quizResult');
  const leaderboardArea = document.getElementById('leaderboardArea');

  // 场景数组
  const scenes = [
    document.getElementById('scene1'),
    document.getElementById('scene2'),
    document.getElementById('scene3'),
    document.getElementById('scene4'),
    document.getElementById('scene5'),
    document.getElementById('scene6'),
  ];
  let currentSceneIndex = 0;
  let sceneTimers = [];

  // next-part按钮
  const scene1NextBtn = document.getElementById('scene1NextBtn');
  const scene2NextBtn = document.getElementById('scene2NextBtn');
  const scene3NextBtn = document.getElementById('scene3NextBtn');
  const scene4NextBtn = document.getElementById('scene4NextBtn');
  const scene5NextBtn = document.getElementById('scene5NextBtn');

  /* 主菜单切换 */
  function showMainMenu() {
    mainMenu.classList.remove('hidden');
    animationPage.classList.add('hidden');
    quizPage.classList.add('hidden');
  }
  function showAnimationPage() {
    mainMenu.classList.add('hidden');
    animationPage.classList.remove('hidden');
    quizPage.classList.add('hidden');
    startScenePlay(); 
  }
  function showQuizPage() {
    mainMenu.classList.add('hidden');
    animationPage.classList.add('hidden');
    quizPage.classList.remove('hidden');
    // 重置问答结果
    quizResult.textContent = "";
    leaderboardArea.textContent = "";
  }

  btnGoAnimation.addEventListener('click', showAnimationPage);
  btnGoQuiz.addEventListener('click', showQuizPage);
  btnBackMenuFromAnimation.addEventListener('click', showMainMenu);
  btnBackMenuFromQuiz.addEventListener('click', showMainMenu);

  /* 问答提交 */
  quizSubmitBtn.addEventListener('click', () => {
    const questions = document.querySelectorAll('.quiz-question');
    let correctCount = 0;
    let totalCount = questions.length;

    questions.forEach(q => {
      const correctAnswer = q.getAttribute('data-answer');
      const inputs = q.querySelectorAll('input[type="radio"]');
      let userAnswer = null;
      inputs.forEach(ip => {
        if(ip.checked) {
          userAnswer = ip.value;
        }
      });
      if(userAnswer === correctAnswer) {
        correctCount++;
      }
    });

    quizResult.textContent = `本次答对：${correctCount} / ${totalCount} 题`;

    // 下面演示添加“杨金老师”、“辛宇老师”、“胡明波老师” 和 “AI对手”的本地头像
    // 请在images目录下准备相应图片，如 yangjin.png, xinyu.png, humingbo.png, ai.png
    const teacherScores = [
      { 
        name: '杨金老师', 
        score: totalCount, 
        avatar: 'images/yangjin.png'  // 本地图片
      },
      {
        name: '辛宇老师', 
        score: totalCount-1,
        avatar: 'images/xinyu.png'
      },
      {
        name: '胡明波老师', 
        score: Math.max(1,totalCount-1),
        avatar: 'images/humingbo.png'
      },
      {
        name: 'AI 对手',
        score: totalCount-2, 
        avatar: 'images/ai.png'
      }
    ];

    // 生成排行榜
    let rankingText = `<p>排行榜（与老师 & AI 对手对比）：</p>`;
    rankingText += `<div class="rank-item" style="justify-content:center;">
      <strong>你：</strong> ${correctCount} / ${totalCount}
    </div>`;

    teacherScores.forEach(ts => {
      rankingText += `
      <div class="rank-item">
        <img src="${ts.avatar}" alt="${ts.name}头像" />
        <span>${ts.name}：${ts.score} / ${totalCount}</span>
      </div>
      `;
    });

    leaderboardArea.innerHTML = rankingText;
  });

  /* 场景动画逻辑 */
  function showScene(idx) {
    scenes.forEach(s => s.classList.remove('active'));
    scenes[idx].classList.add('active');
  }
  function fadeTransition(fromIndex, toIndex) {
    scenes[fromIndex].classList.add('fade-out');
    setTimeout(() => {
      scenes[fromIndex].classList.remove('active','fade-out');
      showScene(toIndex);
      scenes[toIndex].classList.add('fade-in');
      setTimeout(() => {
        scenes[toIndex].classList.remove('fade-in');
      }, 1500);
    }, 1500);
  }

  /* 手动跳过当前场景 */
  function skipToNextScene() {
    if(currentSceneIndex < scenes.length - 1) {
      clearTimeout(sceneTimers[currentSceneIndex]);
      fadeTransition(currentSceneIndex, currentSceneIndex+1);
      currentSceneIndex++;
      if(currentSceneIndex === 3) {
        initGame(); // 场景4(小游戏)
      }
      // 场景5等待30秒后自动到6
      if(currentSceneIndex === 4) {
        sceneTimers[4] = setTimeout(()=>{
          fadeTransition(4,5);
          currentSceneIndex=5;
        },30000);
      }
    }
  }
  scene1NextBtn.addEventListener('click', skipToNextScene);
  scene2NextBtn.addEventListener('click', skipToNextScene);
  scene3NextBtn.addEventListener('click', skipToNextScene);
  scene4NextBtn.addEventListener('click', skipToNextScene);
  scene5NextBtn.addEventListener('click', skipToNextScene);

  /* 场景播放：1~3自动30s,4(游戏),5->6 */
  function startScenePlay() {
    sceneTimers.forEach(t=>clearTimeout(t));
    sceneTimers=[];
    currentSceneIndex=0;
    showScene(0);

    // 场景1->2
    sceneTimers[0] = setTimeout(()=>{
      fadeTransition(0,1);
      currentSceneIndex=1;
    },30000);

    // 场景2->3
    sceneTimers[1] = setTimeout(()=>{
      fadeTransition(1,2);
      currentSceneIndex=2;
    },60000);

    // 场景3->4
    sceneTimers[2] = setTimeout(()=>{
      fadeTransition(2,3);
      currentSceneIndex=3;
      initGame();
    },90000);
  }

  /* 场景4小游戏 */
  let timeElapsed=0, timerInterval=null, stepCount=0, isGameOver=false;
  let waterLowered=false, boatInChamber=false, waterRaised=false, boatOut=false;

  const valveTop=document.getElementById('valveTop');
  const valveBottom=document.getElementById('valveBottom');
  const gateLeft=document.getElementById('gateLeft');
  const gateRight=document.getElementById('gateRight');
  const chamberWater=document.getElementById('chamberWater');
  const lockBoat=document.getElementById('lockBoat');

  const openTopValveBtn=document.getElementById('openTopValve');
  const closeTopValveBtn=document.getElementById('closeTopValve');
  const openBottomValveBtn=document.getElementById('openBottomValve');
  const closeBottomValveBtn=document.getElementById('closeBottomValve');
  const openLeftGateBtn=document.getElementById('openLeftGate');
  const closeLeftGateBtn=document.getElementById('closeLeftGate');
  const openRightGateBtn=document.getElementById('openRightGate');
  const closeRightGateBtn=document.getElementById('closeRightGate');
  const resetGameBtn=document.getElementById('resetGame');

  const timerText=document.getElementById('timerText');
  const stepsText=document.getElementById('stepsText');
  const gameStatus=document.getElementById('gameStatus');

  const gameHelpOverlay=document.getElementById('gameHelpOverlay');
  const btnShowGameHelp=document.getElementById('btnShowGameHelp');
  const btnCloseHelp=document.getElementById('btnCloseHelp');

  btnShowGameHelp.addEventListener('click',()=>{
    gameHelpOverlay.style.display='block';
  });
  btnCloseHelp.addEventListener('click',()=>{
    gameHelpOverlay.style.display='none';
  });

  function disableAllGameBtns(ms=1500){
    [
      openTopValveBtn, closeTopValveBtn,
      openBottomValveBtn, closeBottomValveBtn,
      openLeftGateBtn, closeLeftGateBtn,
      openRightGateBtn, closeRightGateBtn
    ].forEach(btn=>{
      btn.disabled=true;
      setTimeout(()=>{ btn.disabled=false; },ms);
    });
  }

  function initGame(){
    timeElapsed=0; 
    stepCount=0; 
    isGameOver=false;
    waterLowered=false; 
    boatInChamber=false;
    waterRaised=false;
    boatOut=false;

    valveTop.classList.remove('open');
    valveBottom.classList.remove('open');
    gateLeft.classList.remove('open-left');
    gateRight.classList.remove('open-right');

    chamberWater.style.height='80%';
    lockBoat.style.left='-8%'; 
    lockBoat.style.bottom='10%';

    timerText.textContent='0';
    stepsText.textContent='0';
    gameStatus.textContent='等待操作';

    if(timerInterval) clearInterval(timerInterval);
    timerInterval=setInterval(()=>{
      if(!isGameOver){
        timeElapsed++;
        timerText.textContent=timeElapsed.toString();
      }
    },1000);
  }

  function addStep(){
    if(!isGameOver){
      stepCount++;
      stepsText.textContent=stepCount.toString();
    }
  }

  function failAction(msg){
    if(!isGameOver){
      isGameOver=true;
      gameStatus.textContent='操作错误：'+msg;
      clearInterval(timerInterval);
      alert('操作错误！'+msg+'\n请点击“重新开始”重试。');
    }
  }

  function checkWin(){
    if(boatOut && !isGameOver){
      isGameOver=true;
      gameStatus.textContent=`通关！耗时${timeElapsed}s，操作${stepCount}次`;
      clearInterval(timerInterval);
      alert(`恭喜你完成水闸操作！\n耗时：${timeElapsed}秒\n操作：${stepCount}次\n可等待自动跳转或点击“进入下一部分”`);
    }
  }

  /* 游戏按钮事件 */
  openTopValveBtn.addEventListener('click',()=>{
    if(isGameOver) return;
    addStep(); 
    disableAllGameBtns();
    if(boatInChamber){
      failAction('船在闸室里，不能再开上阀排水。');
      return;
    }
    valveTop.classList.add('open');
    gameStatus.textContent='上阀已开启，水位下降中...';
    chamberWater.style.height='40%';
  });
  closeTopValveBtn.addEventListener('click',()=>{
    if(isGameOver) return;
    addStep(); 
    disableAllGameBtns();
    if(!valveTop.classList.contains('open')){
      failAction('上阀未开启，无法关闭！');
      return;
    }
    const hVal=parseInt(chamberWater.style.height);
    if(hVal>45){
      failAction('水位尚未降到约40%，就关闭上阀？');
      return;
    }
    valveTop.classList.remove('open');
    waterLowered=true;
    gameStatus.textContent='上阀已关闭，水位保持低位(40%)。';
  });
  openLeftGateBtn.addEventListener('click',()=>{
    if(isGameOver) return;
    addStep(); 
    disableAllGameBtns();
    if(!waterLowered){
      failAction('还没将水位降到下游水平，就想打开上闸门？');
      return;
    }
    if(boatInChamber){
      failAction('船已在闸室，无需再开上闸门。');
      return;
    }
    gateLeft.classList.add('open-left');
    gameStatus.textContent='上闸门已打开，船正在进入...';
    setTimeout(()=>{
      lockBoat.style.left='35%';
      setTimeout(()=>{ boatInChamber=true; },1500);
    },100);
  });
  closeLeftGateBtn.addEventListener('click',()=>{
    if(isGameOver) return;
    addStep(); 
    disableAllGameBtns();
    if(!gateLeft.classList.contains('open-left')){
      failAction('上闸门未打开，无法关闭。');
      return;
    }
    if(!boatInChamber){
      failAction('船尚未进入闸室就关闭闸门？');
      return;
    }
    gateLeft.classList.remove('open-left');
    gameStatus.textContent='上闸门已关闭。';
  });
  openBottomValveBtn.addEventListener('click',()=>{
    if(isGameOver) return;
    addStep(); 
    disableAllGameBtns();
    if(!boatInChamber){
      failAction('船还没进闸室，就开启下阀？');
      return;
    }
    if(valveBottom.classList.contains('open')){
      failAction('下阀已是开启状态。');
      return;
    }
    valveBottom.classList.add('open');
    chamberWater.style.height='80%';
    gameStatus.textContent='下阀已开启，水位升回上游高度...';
  });
  closeBottomValveBtn.addEventListener('click',()=>{
    if(isGameOver) return;
    addStep(); 
    disableAllGameBtns();
    if(!valveBottom.classList.contains('open')){
      failAction('下阀并未开启，无法关闭。');
      return;
    }
    const hVal=parseInt(chamberWater.style.height);
    if(hVal<75){
      failAction('水位尚未升到80%，就关闭下阀？');
      return;
    }
    valveBottom.classList.remove('open');
    waterRaised=true;
    gameStatus.textContent='下阀已关闭，上游水位保持(80%)。';
  });
  openRightGateBtn.addEventListener('click',()=>{
    if(isGameOver) return;
    addStep(); 
    disableAllGameBtns();
    if(!waterRaised){
      failAction('还没把水位升回高位，就打开下闸门？');
      return;
    }
    gateRight.classList.add('open-right');
    gameStatus.textContent='下闸门已打开，船驶出...';
    setTimeout(()=>{
      lockBoat.style.left='110%';
      setTimeout(()=>{
        boatOut=true;
        checkWin();
      },1500);
    },100);
  });
  closeRightGateBtn.addEventListener('click',()=>{
    if(isGameOver) return;
    addStep(); 
    disableAllGameBtns();
    if(!gateRight.classList.contains('open-right')){
      failAction('下闸门未打开，无法关闭。');
      return;
    }
    if(!boatOut){
      failAction('船尚未离开，就要关闭下闸门？');
      return;
    }
    gateRight.classList.remove('open-right');
    gameStatus.textContent='下闸门已关闭。';
  });
  resetGameBtn.addEventListener('click',()=>{
    initGame();
  });

  /* 自动场景切换 + “进入下一部分”按钮功能 */
  function skipToNextScene() {
    if(currentSceneIndex < scenes.length - 1) {
      clearTimeout(sceneTimers[currentSceneIndex]);
      fadeTransition(currentSceneIndex, currentSceneIndex+1);
      currentSceneIndex++;
      if(currentSceneIndex === 3) {
        initGame();
      }
      if(currentSceneIndex === 4) {
        sceneTimers[4] = setTimeout(()=>{
          fadeTransition(4,5);
          currentSceneIndex=5;
        },30000);
      }
    }
  }
  scene1NextBtn.addEventListener('click', skipToNextScene);
  scene2NextBtn.addEventListener('click', skipToNextScene);
  scene3NextBtn.addEventListener('click', skipToNextScene);
  scene4NextBtn.addEventListener('click', skipToNextScene);
  scene5NextBtn.addEventListener('click', skipToNextScene);

  function startScenePlay(){
    sceneTimers.forEach(t=>clearTimeout(t));
    sceneTimers=[];
    currentSceneIndex=0;
    showScene(0);

    // 1->2
    sceneTimers[0]=setTimeout(()=>{
      fadeTransition(0,1);
      currentSceneIndex=1;
    },30000);

    // 2->3
    sceneTimers[1]=setTimeout(()=>{
      fadeTransition(1,2);
      currentSceneIndex=2;
    },60000);

    // 3->4
    sceneTimers[2]=setTimeout(()=>{
      fadeTransition(2,3);
      currentSceneIndex=3;
      initGame();
    },90000);
  }

  // 默认显示主菜单
  showMainMenu();
</script>
</body>
</html>
